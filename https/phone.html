<!DOCTYPE html>
<html>
	<head>
		<title>视频通话</title>
	</head>
	<body>
		<video id="my-video" autoplay></video>
		<video id="your-video" autoplay></video>
		<br />
		<input
			type="text"
			value="test"
			id="pullStreamName"
			placeholder="拉取流的名称"
		/>
		<p id="pullStreamNameShow"></p>
		<button onclick="start()">开始拉流</button>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.dev.js"></script>
		<script src="https://cdn.bootcss.com/flv.js/1.4.0/flv.min.js"></script>
		<script>
			function start(pullStreamName) {
				if (flvjs.isSupported()) {
					var videoElement = document.getElementById('videoElement')
					let streamUrl = `https://47.56.153.188:8000/live/${pullStreamName}.flv`
					document.getElementById('pullStreamNameShow').innerHTML = streamUrl
					;(() => {
						var flvPlayer = flvjs.createPlayer({
							type: 'flv',
							url: streamUrl
						})
						flvPlayer.attachMediaElement(videoElement)
						flvPlayer.load()
						flvPlayer.play()
					})()
				}
			}

			var socket = io('https://47.56.153.188:3000')
			socket.on('connect', () => {
				document.getElementById('pullStreamName').value = socket.id
				startCapture(
					{
						audio: true,
						video: true
					},
					socket.id
				)
			})

			async function startCapture(displayMediaOptions, room) {
				let captureStream = null
				try {
					captureStream = await navigator.mediaDevices.getUserMedia(
						displayMediaOptions
					)
					let videoTracks = captureStream.getVideoTracks()
					let videoElement = document.getElementById('video')
					videoElement.srcObject = captureStream

					let mediaRecorder = new MediaRecorder(captureStream, {
						mimeType: 'video/webm;codecs=h264'
					})

					mediaRecorder.ondataavailable = function (event) {
						socket.emit(room, event.data)
					}
					mediaRecorder.start(1000)
				} catch (err) {
					console.error('Error: ' + err)
				}
				return captureStream
			}
		</script>
	</body>
</html>
